const NAME="DOM99",ELEMENT_NODE=1,CONTEXT="DOM99_C",LIST_ITEM_PROPERTY="DOM99_L",ELEMENT_PROPERTY="DOM99_E",ELEMENT_LIST_ITEM="DOM99_I",CUSTOM_ELEMENT="DOM99_X",LIST_CHILDREN="DOM99_R",INSIDE_SYMBOL=">",variableSubscribers={},listSubscribers={},variables={},elements={},templateFromName={},functions={};let directivePairs,pathIn=[];const hasOwnProperty=Object.prototype.hasOwnProperty,freezeLiveCollection=function(e){const t=e.length,n=[];let r;for(r=0;r<t;r+=1)n.push(e[r]);return n},isObjectOrArray=function(e){return"object"==typeof e&&null!==e},copyArrayFlat=function(e){return e.slice()},pushOrCreateArrayAt=function(e,t,n){hasOwnProperty.call(e,t)?e[t].push(n):e[t]=[n]},MISS="MISS",valueElseMissDecorator=function(e){return function(t){return hasOwnProperty.call(e,t)?e[t]:e.MISS}},propertyFromTag=valueElseMissDecorator({INPUT:"value",TEXTAREA:"value",PROGRESS:"value",SELECT:"value",IMG:"src",SOURCE:"src",AUDIO:"src",VIDEO:"src",TRACK:"src",SCRIPT:"src",OPTION:"value",LINK:"href",DETAILS:"open",MISS:"textContent"}),propertyFromInputType=valueElseMissDecorator({checkbox:"checked",radio:"checked",MISS:"value"}),inputEventFromType=valueElseMissDecorator({checkbox:"change",radio:"change",range:"change",file:"change",MISS:"input"}),eventFromTag=valueElseMissDecorator({SELECT:"change",TEXTAREA:"input",BUTTON:"click",MISS:"click"}),options={doneSymbol:"*",tokenSeparator:"-",listSeparator:" ",directives:{"function":"data-function",variable:"data-variable",element:"data-element",list:"data-list",inside:"data-inside",template:"data-template"},propertyFromElement:function(e){let t;return"INPUT"===(t=e.tagName!==undefined?e.tagName:e)?propertyFromInputType(e.type):propertyFromTag(t)},eventNameFromElement:function(e){const t=e.tagName;return"INPUT"===t?inputEventFromType(e.type):eventFromTag(t)},tagNamesForUserInput:["INPUT","TEXTAREA","SELECT","DETAILS"]},createElement2=function(e){const t=document.createElement(e.tagName);return Object.entries(e).forEach(function([e,n]){"tagName"!==e&&t.setAttribute(e,n)}),t},elementsDeepForEach=function(e,t){t(e);let n=e.firstChild;for(;n;)1===n.nodeType?(elementsDeepForEach(n,t),n=n.nextElementSibling):n=n.nextSibling},customElementNameFromElement=function(e){const t=e.getAttribute("is");return t||e.tagName.toLowerCase()},addEventListener=function(e,t,n,r=!1){e.addEventListener(t,n,r)},cloneTemplate=function(e){return e.content,document.importNode(e.content,!0)},contextFromEvent=function(e,t){if(e||t){let n;if(n=e&&e.target?e.target:t,hasOwnProperty.call(n,CONTEXT))return n.DOM99_C;if(n.parentNode)return contextFromEvent(undefined,n.parentNode)}return""},contextFromArray=function(e){return e.join(">")},enterObject=function(e){pathIn.push(e)},leaveObject=function(){pathIn.pop()},getParentContext=function(e){const t=e.split(">");return t.pop(),t.join(">")},contextFromArrayWith=function(e,t){return 0===e.length?t:`${contextFromArray(e)}>${t}`},normalizeStartPath=function(e){return e?`${e}>`:e},deleteAllStartsWith=function(e,t){Object.keys(e).forEach(function(n){n.startsWith(t)&&delete e[n]})},forgetContext=function(e){deleteAllStartsWith(variableSubscribers,e),deleteAllStartsWith(listSubscribers,e),deleteAllStartsWith(variables,e),deleteAllStartsWith(elements,e)},notifyOneVariableSubscriber=function(e,t){e[e.DOM99_E]=t},notifyVariableSubscribers=function(e,t){t!==undefined&&e.forEach(function(e){notifyOneVariableSubscriber(e,t)})},removeNode=function(e){e.remove()},notifyOneListSubscriber=function(e,t,n){const r=document.createDocumentFragment();if(hasOwnProperty.call(e,"DOM99_X")&&hasOwnProperty.call(templateFromName,e.DOM99_X)){const o=templateFromName[e.DOM99_X],i=pathIn.slice();pathIn=t.split(">");const a=normalizeStartPath(t),c=n.length;let s,l;if(hasOwnProperty.call(e,"DOM99_R")){if((s=e.DOM99_R.length)>c){let t;for(t=c;t<s;t+=1)l=`${a}${t}`,e.DOM99_R[t].forEach(removeNode),forgetContext(l);e.DOM99_R.length=c}}else e.DOM99_R=[],s=0;n.forEach(function(t,n){if(feed(l=`${a}${n}`,t),n>=s){const t=activateCloneTemplate(o,String(n));e.DOM99_R.push(freezeLiveCollection(t.childNodes)),r.appendChild(t)}}),pathIn=i}else e.innerHTML="",n.forEach(function(t){const n=document.createElement(e.DOM99_I);isObjectOrArray(t)?Object.assign(n,t):n[e.DOM99_L]=t,r.appendChild(n)});e.appendChild(r)},notifyListSubscribers=function(e,t,n){e.forEach(function(e){notifyOneListSubscriber(e,t,n)})},feed=function(e,t){if(t===undefined&&(t=e,e=""),isObjectOrArray(e),isObjectOrArray(t))if(Array.isArray(t))variables[e]=t,hasOwnProperty.call(listSubscribers,e)&&notifyListSubscribers(listSubscribers[e],e,t);else{const n=normalizeStartPath(e);Object.entries(t).forEach(function([e,t]){feed(`${n}${e}`,t)})}else variables[e]=t,hasOwnProperty.call(variableSubscribers,e)&&(n=variableSubscribers[e],(r=t)!==undefined&&n.forEach(function(e){notifyOneVariableSubscriber(e,r)}));var n,r},applyFunctionOriginal=function(e,t,n){addEventListener(e,t,functions[n]),e.DOM99_C=contextFromArray(pathIn)},pluggedFunctions=[];let applyFunction=applyFunctionOriginal;const applyFunctions=function(e,t){t.split(options.listSeparator).forEach(function(t){const n=t.split(options.tokenSeparator);let r,o;1===n.length?(r=n[0],o=options.eventNameFromElement(e)):[o,r]=n,applyFunction(e,o,r)})},applylist=function(e,t){const[n,r,o]=t.split(options.tokenSeparator);let i="-";o?(i=`${r}-${o}`,e.DOM99_X=i):(e.DOM99_L=options.propertyFromElement(r.toUpperCase()),e.DOM99_I=r);const a=contextFromArrayWith(pathIn,n);pushOrCreateArrayAt(listSubscribers,a,e),hasOwnProperty.call(variables,a)&&notifyOneListSubscriber(e,a,variables[a])},applyVariable=function(e,t){e.DOM99_E=options.propertyFromElement(e);const n=contextFromArrayWith(pathIn,t);pushOrCreateArrayAt(variableSubscribers,n,e);const r=variables[n];if(r!==undefined&&notifyOneVariableSubscriber(e,r),options.tagNamesForUserInput.includes(e.tagName)){const t=function(t){const r=t.target[t.target.DOM99_E];variables[n]=r,variableSubscribers[n].forEach(function(t){t!==e&&notifyOneVariableSubscriber(t,r)})};addEventListener(e,options.eventNameFromElement(e),t)}},applyDirectiveElement=function(e,t){const n=t,r=contextFromArrayWith(pathIn,n);elements[r]=e},applytemplate=function(e,t){templateFromName[t]=e},activateCloneTemplate=function(e,t){enterObject(t);const n=cloneTemplate(e);return activate(n),leaveObject(),n},applyInside=function(e,t){const n=templateFromName[customElementNameFromElement(e)];if(n){const r=activateCloneTemplate(n,t);e.appendChild(r)}else e.setAttribute(options.directives.inside,options.doneSymbol+t),enterObject(t),activate(e),leaveObject()},deleteTemplate=function(e){hasOwnProperty.call(templateFromName,e),templateFromName[e].remove(),delete templateFromName[e]},tryApplyDirectives=function(e){if(!e.hasAttribute)return;const t=Object.values(options.directives);if(Array.prototype.slice.call(e.attributes).forEach(function(e){e.nodeName.startsWith("data")&&t.includes(e.nodeName)}),directivePairs.forEach(function([t,n]){if(!e.hasAttribute(t))return;const r=e.getAttribute(t);r[0]!==options.doneSymbol&&(n(e,r),e.setAttribute(t,`${options.doneSymbol}${r}`))}),e.hasAttribute(options.directives.inside)||e.hasAttribute(options.directives.list))return;let n=customElementNameFromElement(e);hasOwnProperty.call(templateFromName,n)&&e.appendChild(cloneTemplate(templateFromName[n]))},activate=function(e=document.body){return directivePairs||(directivePairs=[[options.directives.element,applyDirectiveElement],[options.directives.variable,applyVariable],[options.directives["function"],applyFunctions],[options.directives.list,applylist],[options.directives.inside,applyInside],[options.directives.template,applytemplate]]),elementsDeepForEach(e,tryApplyDirectives),e},start=function(e={},t={},n=document.body,r=undefined){if(Object.assign(functions,e),feed(t),activate(n),r)return r()},plugin=function(e){hasOwnProperty.call(e,"directives")&&hasOwnProperty.call(e.directives,"function")&&(pluggedFunctions.push(e.directives["function"]),applyFunction=function(e,t,n){let r=!1;const o=function(){r=!0};pluggedFunctions.forEach(function(r){r(e,t,n,functions,o)}),r||applyFunctionOriginal(e,t,n)})},dom99core=Object.freeze({start:start,activate:activate,elements:elements,functions:functions,variables:variables,feed:feed,forgetContext:forgetContext,deleteTemplate:deleteTemplate,contextFromArray:contextFromArray,contextFromEvent:contextFromEvent,getParentContext:getParentContext});export{dom99core as d,plugin,options,createElement2};